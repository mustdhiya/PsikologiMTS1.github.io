{% extends 'base.html' %}
{% load static %}

{% block title %}Daftar Siswa & RMIB - PRESTISIA{% endblock %}

{% block extra_css %}
<style>
/* ==================== MODERN ANIMATIONS 2025 ==================== */
@keyframes fadeInUp {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes slideInRight {
    from { 
        opacity: 0; 
        transform: translateX(-20px); 
    }
    to { 
        opacity: 1; 
        transform: translateX(0); 
    }
}

@keyframes scaleIn {
    from { 
        opacity: 0; 
        transform: scale(0.9); 
    }
    to { 
        opacity: 1; 
        transform: scale(1); 
    }
}

@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

.animate-fadeInUp {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
}

.animate-slideInRight {
    animation: slideInRight 0.5s ease-out forwards;
    opacity: 0;
}

.animate-scaleIn {
    animation: scaleIn 0.4s ease-out forwards;
    opacity: 0;
}

/* Staggered animation delays */
.delay-100 { animation-delay: 0.1s; }
.delay-200 { animation-delay: 0.2s; }
.delay-300 { animation-delay: 0.3s; }
.delay-400 { animation-delay: 0.4s; }

/* ==================== MODERN CARD DESIGN ==================== */
.card-modern {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(226, 232, 240, 0.8);
}

.card-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.card-glass {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.18);
}

/* ==================== GRADIENT BACKGROUNDS ==================== */
.gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.gradient-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.gradient-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.gradient-info {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.gradient-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

/* ==================== STATS CARD ==================== */
.stats-card {
    position: relative;
    overflow: hidden;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
}

.stats-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

/* ==================== MODERN TABLE DESIGN ==================== */
.table-modern {
    border-spacing: 0 8px;
    border-collapse: separate;
}

.table-modern thead th {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 16px;
    font-weight: 600;
    color: #475569;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.05em;
    border: none;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table-modern tbody tr {
    background: white;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease;
}

.table-modern tbody tr:hover {
    transform: scale(1.01);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    z-index: 1;
}

.table-modern tbody td {
    padding: 16px;
    border: none;
    vertical-align: middle;
}

.table-modern tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
}

.table-modern tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
}

/* ==================== AVATAR DESIGN ==================== */
.avatar-modern {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 18px;
    color: white;
    position: relative;
    overflow: hidden;
}

.avatar-modern::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
}

/* ==================== BADGE DESIGN ==================== */
.badge-modern {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.025em;
    transition: all 0.2s ease;
}

.badge-modern:hover {
    transform: scale(1.05);
}

.badge-pending {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
}

.badge-completed {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.badge-in-progress {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
}

/* ==================== BUTTON DESIGN ==================== */
.btn-modern {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.btn-modern::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
    opacity: 0;
    transition: opacity 0.2s ease;
}

.btn-modern:hover::before {
    opacity: 1;
}

.btn-modern:active {
    transform: scale(0.98);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-outline {
    background: white;
    border: 2px solid #e2e8f0;
    color: #475569;
}

.btn-outline:hover {
    border-color: #667eea;
    color: #667eea;
}

/* ==================== SEARCH & FILTER DESIGN ==================== */
.search-box {
    position: relative;
}

.search-box input {
    padding-left: 48px;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    transition: all 0.2s ease;
}

.search-box input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.search-box .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 18px;
}

.filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f1f5f9;
    border-radius: 8px;
    font-size: 13px;
    color: #475569;
}

.filter-tag button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #cbd5e1;
    color: #475569;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-tag button:hover {
    background: #94a3b8;
    color: white;
}

/* ==================== PROGRESS BAR ==================== */
.progress-bar {
    height: 8px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.progress-bar-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

/* ==================== TOOLTIP ==================== */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    background-color: #1e293b;
    color: white;
    text-align: center;
    padding: 8px 12px;
    border-radius: 8px;
    position: absolute;
    z-index: 100;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 12px;
    white-space: nowrap;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

/* ==================== EMPTY STATE ==================== */
.empty-state {
    text-align: center;
    padding: 80px 20px;
}

.empty-state-icon {
    width: 120px;
    height: 120px;
    margin: 0 auto 24px;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: #94a3b8;
}

/* ==================== PAGINATION ==================== */
.pagination {
    display: flex;
    gap: 8px;
    align-items: center;
}

.pagination-item {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 12px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    background: white;
    color: #475569;
    border: 2px solid #e2e8f0;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.pagination-item:hover {
    border-color: #667eea;
    color: #667eea;
    transform: translateY(-2px);
}

.pagination-item.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
}

.pagination-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

/* ==================== MODAL DESIGN ==================== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-overlay.active {
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.modal-overlay.active .modal-content {
    transform: scale(1);
}

/* ==================== LOADING SPINNER ==================== */
.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ==================== RESPONSIVE DESIGN ==================== */
@media (max-width: 1024px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .table-modern {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-responsive {
        flex-direction: column;
        gap: 12px;
    }
    
    .btn-modern {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 640px) {
    .card-modern {
        border-radius: 12px;
    }
    
    .table-modern thead {
        display: none;
    }
    
    .table-modern tbody tr {
        display: flex;
        flex-direction: column;
        margin-bottom: 16px;
        padding: 16px;
        border-radius: 12px;
    }
    
    .table-modern tbody td {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .table-modern tbody td:last-child {
        border-bottom: none;
    }
    
    .table-modern tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #64748b;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
}

/* ==================== PRINT STYLES ==================== */
@media print {
    .no-print {
        display: none !important;
    }
    
    .table-modern tbody tr {
        box-shadow: none;
        border: 1px solid #e2e8f0;
    }
}

/* ==================== SCROLLBAR STYLING ==================== */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5568d3 0%, #6a3d91 100%);
}

/* ==================== SELECTION HIGHLIGHT ==================== */
::selection {
    background: rgba(102, 126, 234, 0.2);
    color: inherit;
}

::-moz-selection {
    background: rgba(102, 126, 234, 0.2);
    color: inherit;
}
</style>
{% endblock %}

{% block content %}
<!-- ==================== HEADER SECTION ==================== -->
<header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white shadow-2xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="animate-fadeInUp">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <!-- Title Section -->
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur-lg rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-users-class text-3xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl lg:text-4xl font-bold tracking-tight">Daftar Siswa</h1>
                        <p class="text-indigo-100 mt-1">Manajemen data siswa dan tes RMIB</p>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 no-print">
                    <a href="{% url 'students:export_csv' %}" class="btn-modern btn-outline bg-white/10 backdrop-blur-lg text-white border-white/30 hover:bg-white/20">
                        <i class="fas fa-file-export"></i>
                        <span>Export CSV</span>
                    </a>
                    {% if request.user.is_staff %}
                    <a href="{% url 'students:batch_import' %}" class="btn-modern btn-outline bg-white/10 backdrop-blur-lg text-white border-white/30 hover:bg-white/20">
                        <i class="fas fa-file-import"></i>
                        <span>Import Batch</span>
                    </a>
                    {% endif %}
                    <a href="{% url 'students:create' %}" class="btn-modern btn-success shadow-lg hover:shadow-xl">
                        <i class="fas fa-user-plus"></i>
                        <span>Tambah Siswa</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- ==================== STATS CARDS SECTION ==================== -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8 relative z-10">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 stats-grid">
        <!-- Total Students Card -->
        <div class="card-modern stats-card animate-scaleIn delay-100">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="stats-icon gradient-primary text-white">
                        <i class="fas fa-users"></i>
                    </div>
                    <span class="text-xs font-semibold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full">
                        Total
                    </span>
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ total_students }}</h3>
                    <p class="text-sm text-gray-600">Total Siswa</p>
                </div>
                <div class="mt-4">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Tests Card -->
        <div class="card-modern stats-card animate-scaleIn delay-200">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="stats-icon gradient-success text-white">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <span class="text-xs font-semibold text-green-600 bg-green-100 px-3 py-1 rounded-full">
                        {% if total_students > 0 %}
                            {% widthratio completed_tests total_students 100 %}%
                        {% else %}
                            0%
                        {% endif %}
                    </span>
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ completed_tests }}</h3>
                    <p class="text-sm text-gray-600">Tes Selesai</p>
                </div>
                <div class="mt-4">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: {% if total_students > 0 %}{% widthratio completed_tests total_students 100 %}{% else %}0{% endif %}%; background: linear-gradient(90deg, #10b981 0%, #059669 100%);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- In Progress Tests Card -->
        <div class="card-modern stats-card animate-scaleIn delay-300">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="stats-icon gradient-info text-white">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">
                        {% if total_students > 0 %}
                            {% widthratio in_progress_tests total_students 100 %}%
                        {% else %}
                            0%
                        {% endif %}
                    </span>
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ in_progress_tests }}</h3>
                    <p class="text-sm text-gray-600">Sedang Tes</p>
                </div>
                <div class="mt-4">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: {% if total_students > 0 %}{% widthratio in_progress_tests total_students 100 %}{% else %}0{% endif %}%; background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Tests Card -->
        <div class="card-modern stats-card animate-scaleIn delay-400">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="stats-icon gradient-warning text-white">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span class="text-xs font-semibold text-amber-600 bg-amber-100 px-3 py-1 rounded-full">
                        {% if total_students > 0 %}
                            {% widthratio pending_tests total_students 100 %}%
                        {% else %}
                            0%
                        {% endif %}
                    </span>
                </div>
                <div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ pending_tests }}</h3>
                    <p class="text-sm text-gray-600">Belum Tes</p>
                </div>
                <div class="mt-4">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: {% if total_students > 0 %}{% widthratio pending_tests total_students 100 %}{% else %}0{% endif %}%; background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ==================== SEARCH & FILTER SECTION ==================== -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div class="card-modern p-6 animate-fadeInUp">
        <form method="get" action="{% url 'students:list' %}" class="space-y-6">
            <!-- Search Bar -->
            <div class="search-box">
                <i class="search-icon fas fa-search"></i>
                <input 
                    type="text" 
                    name="search" 
                    value="{{ search }}"
                    placeholder="Cari nama, NISN, kelas, atau tempat lahir..."
                    class="w-full px-4 py-3 text-gray-900 placeholder-gray-500 focus:ring-2 focus:ring-indigo-500"
                >
            </div>

            <!-- Filters Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Class Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-chalkboard-teacher text-indigo-600 mr-2"></i>Kelas
                    </label>
                    <select name="class" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        <option value="">Semua Kelas</option>
                        {% for class in available_classes %}
                        <option value="{{ class }}" {% if class_filter == class %}selected{% endif %}>
                            Kelas {{ class }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-tasks text-green-600 mr-2"></i>Status Tes
                    </label>
                    <select name="status" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        <option value="">Semua Status</option>
                        {% for status_value, status_label in status_choices %}
                        <option value="{{ status_value }}" {% if status_filter == status_value %}selected{% endif %}>
                            {{ status_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Gender Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-venus-mars text-purple-600 mr-2"></i>Jenis Kelamin
                    </label>
                    <select name="gender" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        <option value="">Semua</option>
                        {% for gender_value, gender_label in gender_choices %}
                        <option value="{{ gender_value }}" {% if gender_filter == gender_value %}selected{% endif %}>
                            {{ gender_label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Year Filter -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-calendar text-blue-600 mr-2"></i>Tahun Masuk
                    </label>
                    <select name="year" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        <option value="">Semua Tahun</option>
                        {% for year in available_years %}
                        <option value="{{ year }}" {% if year_filter == year|stringformat:"s" %}selected{% endif %}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sort -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-sort text-gray-600 mr-2"></i>Urutkan
                    </label>
                    <select name="sort" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                        <option value="">Default</option>
                        <option value="name" {% if sort == 'name' %}selected{% endif %}>Nama A-Z</option>
                        <option value="nisn" {% if sort == 'nisn' %}selected{% endif %}>NISN</option>
                        <option value="class" {% if sort == 'class' %}selected{% endif %}>Kelas</option>
                        <option value="status" {% if sort == 'status' %}selected{% endif %}>Status</option>
                        <option value="date" {% if sort == 'date' %}selected{% endif %}>Terbaru</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3">
                <button type="submit" class="btn-modern btn-primary">
                    <i class="fas fa-filter"></i>
                    <span>Terapkan Filter</span>
                </button>
                <a href="{% url 'students:list' %}" class="btn-modern btn-outline">
                    <i class="fas fa-redo"></i>
                    <span>Reset</span>
                </a>
            </div>

            <!-- Active Filters Display -->
            {% if search or class_filter or status_filter or gender_filter or year_filter %}
            <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-gray-200">
                <span class="text-sm font-semibold text-gray-700">Filter Aktif:</span>
                {% if search %}
                <div class="filter-tag">
                    <i class="fas fa-search text-xs"></i>
                    <span>{{ search }}</span>
                    <button type="button" onclick="removeFilter('search')">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                {% endif %}
                {% if class_filter %}
                <div class="filter-tag">
                    <i class="fas fa-chalkboard-teacher text-xs"></i>
                    <span>Kelas {{ class_filter }}</span>
                    <button type="button" onclick="removeFilter('class')">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                {% endif %}
                {% if status_filter %}
                <div class="filter-tag">
                    <i class="fas fa-tasks text-xs"></i>
                    <span>{{ status_filter|capfirst }}</span>
                    <button type="button" onclick="removeFilter('status')">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                {% endif %}
                {% if gender_filter %}
                <div class="filter-tag">
                    <i class="fas fa-venus-mars text-xs"></i>
                    <span>{% for g_val, g_label in gender_choices %}{% if g_val == gender_filter %}{{ g_label }}{% endif %}{% endfor %}</span>
                    <button type="button" onclick="removeFilter('gender')">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                {% endif %}
                {% if year_filter %}
                <div class="filter-tag">
                    <i class="fas fa-calendar text-xs"></i>
                    <span>{{ year_filter }}</span>
                    <button type="button" onclick="removeFilter('year')">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </form>
    </div>
</section>

<!-- ==================== BULK ACTIONS (Staff Only) ==================== -->
{% if request.user.is_staff %}
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 no-print">
    <div class="card-modern p-4 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200" id="bulkActionsBar" style="display: none;">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center text-white font-bold">
                    <span id="selectedCount">0</span>
                </div>
                <span class="text-sm font-semibold text-gray-700">siswa dipilih</span>
            </div>
            <div class="flex flex-wrap gap-2">
                <button type="button" onclick="clearSelection()" class="btn-modern btn-outline text-sm">
                    <i class="fas fa-times"></i>
                    <span>Batal</span>
                </button>
                <button type="button" onclick="bulkDelete()" class="btn-modern text-sm" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                    <i class="fas fa-trash-alt"></i>
                    <span>Hapus Terpilih</span>
                </button>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- ==================== DATA TABLE SECTION ==================== -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-12">
    <div class="card-modern p-6">
        <!-- Table Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-table text-indigo-600 mr-2"></i>
                    Data Siswa
                </h2>
                <p class="text-sm text-gray-600 mt-1">
                    Menampilkan 
                    <span class="font-semibold text-indigo-600">
                        {{ page_obj.start_index }}-{{ page_obj.end_index }}
                    </span> 
                    dari 
                    <span class="font-semibold text-indigo-600">{{ page_obj.paginator.count }}</span> 
                    siswa
                </p>
            </div>
            {% if request.user.is_staff %}
            <div class="flex items-center gap-2 no-print">
                <label class="inline-flex items-center gap-2 cursor-pointer text-sm font-semibold text-gray-700">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" class="w-5 h-5 rounded border-2 border-gray-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500">
                    <span>Pilih Semua</span>
                </label>
            </div>
            {% endif %}
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
            {% if students %}
            <table class="table-modern w-full">
                <thead>
                    <tr>
                        {% if request.user.is_staff %}
                        <th class="no-print" style="width: 50px;">
                            <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll(this)" class="w-5 h-5 rounded border-2 border-gray-300 text-indigo-600">
                        </th>
                        {% endif %}
                        <th style="width: 80px;">Avatar</th>
                        <th>Siswa</th>
                        <th>NISN</th>
                        <th>Kelas</th>
                        <th>Jenis Kelamin</th>
                        <th>Status Tes</th>
                        <th>Prestasi</th>
                        <th class="no-print">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr class="animate-fadeInUp" style="animation-delay: {{ forloop.counter|add:"-1"|stringformat:"s" }}00ms;">
                        {% if request.user.is_staff %}
                        <td class="no-print" data-label="">
                            <input type="checkbox" name="student_ids" value="{{ student.pk }}" onchange="updateBulkActions()" class="student-checkbox w-5 h-5 rounded border-2 border-gray-300 text-indigo-600">
                        </td>
                        {% endif %}
                        <td data-label="Avatar">
                            <div class="avatar-modern {% cycle 'gradient-primary' 'gradient-success' 'gradient-info' 'gradient-warning' %}">
                                {{ student.name|first|upper }}
                                <span class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white rounded-full" title="Akun Aktif"></span>
                            </div>
                        </td>
                        <td data-label="Nama">
                            <div>
                                <div class="font-semibold text-gray-900">{{ student.name }}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    <i class="fas fa-map-marker-alt mr-1"></i>{{ student.birth_place|default:"—" }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-birthday-cake mr-1"></i>{{ student.birth_date|date:"d M Y" }}
                                </div>
                            </div>
                        </td>
                        <td data-label="NISN">
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-sm font-semibold text-gray-700">{{ student.nisn }}</span>
                                <button onclick="copyToClipboard('{{ student.nisn }}')" class="tooltip text-gray-400 hover:text-indigo-600 transition">
                                    <i class="fas fa-copy text-sm"></i>
                                    <span class="tooltiptext">Copy NISN</span>
                                </button>
                            </div>
                        </td>
                        <td data-label="Kelas">
                            <span class="inline-flex items-center gap-2 px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg font-semibold text-sm">
                                <i class="fas fa-chalkboard-teacher"></i>
                                {{ student.student_class }}
                            </span>
                        </td>
                        <td data-label="Jenis Kelamin">
                            {% if student.gender == 'L' %}
                            <span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-lg font-semibold text-sm">
                                <i class="fas fa-mars"></i>
                                Laki-laki
                            </span>
                            {% else %}
                            <span class="inline-flex items-center gap-2 px-3 py-1 bg-pink-100 text-pink-700 rounded-lg font-semibold text-sm">
                                <i class="fas fa-venus"></i>
                                Perempuan
                            </span>
                            {% endif %}
                        </td>
                        <td data-label="Status">
                            {% if student.test_status == 'completed' %}
                            <span class="badge-modern badge-completed">
                                <i class="fas fa-check-circle"></i>
                                Selesai
                            </span>
                            {% elif student.test_status == 'in_progress' %}
                            <span class="badge-modern badge-in-progress">
                                <i class="fas fa-spinner fa-spin"></i>
                                Sedang Tes
                            </span>
                            {% else %}
                            <span class="badge-modern badge-pending">
                                <i class="fas fa-clock"></i>
                                Belum Tes
                            </span>
                            {% endif %}
                        </td>
                        <td data-label="Prestasi">
                            {% if student.prestasi.count > 0 %}
                            <div class="tooltip">
                                <span class="inline-flex items-center gap-2 px-3 py-1 bg-amber-100 text-amber-700 rounded-lg font-semibold text-sm">
                                    <i class="fas fa-trophy"></i>
                                    {{ student.prestasi.count }}
                                </span>
                                <span class="tooltiptext">{{ student.prestasi.count }} Prestasi</span>
                            </div>
                            {% else %}
                            <span class="text-sm text-gray-400">—</span>
                            {% endif %}
                        </td>
                        <td data-label="Aksi" class="no-print">
                            <div class="flex flex-wrap gap-2">
                                <a href="{% url 'students:detail' student.pk %}" class="tooltip inline-flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-600 hover:text-white transition">
                                    <i class="fas fa-eye"></i>
                                    <span class="tooltiptext">Lihat Detail</span>
                                </a>
                                {% if request.user.is_staff %}
                                <a href="{% url 'students:update' student.pk %}" class="tooltip inline-flex items-center justify-center w-10 h-10 rounded-lg bg-amber-100 text-amber-600 hover:bg-amber-600 hover:text-white transition">
                                    <i class="fas fa-edit"></i>
                                    <span class="tooltiptext">Edit</span>
                                </a>
                                <button onclick="deleteStudent({{ student.pk }}, '{{ student.name|escapejs }}')" class="tooltip inline-flex items-center justify-center w-10 h-10 rounded-lg bg-red-100 text-red-600 hover:bg-red-600 hover:text-white transition">
                                    <i class="fas fa-trash-alt"></i>
                                    <span class="tooltiptext">Hapus</span>
                                </button>
                                {% endif %}
                                {% if student.test_status != 'completed' %}
                                <a href="{% url 'students:rmib_test' student.pk %}" class="tooltip inline-flex items-center justify-center w-10 h-10 rounded-lg bg-purple-100 text-purple-600 hover:bg-purple-600 hover:text-white transition">
                                    <i class="fas fa-clipboard-list"></i>
                                    <span class="tooltiptext">Mulai Tes RMIB</span>
                                </a>
                                {% else %}
                                <a href="{% url 'students:rmib_result' student.pk %}" class="tooltip inline-flex items-center justify-center w-10 h-10 rounded-lg bg-green-100 text-green-600 hover:bg-green-600 hover:text-white transition">
                                    <i class="fas fa-chart-bar"></i>
                                    <span class="tooltiptext">Lihat Hasil</span>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-users-slash"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Tidak Ada Data</h3>
                <p class="text-gray-600 mb-6">
                    {% if search or class_filter or status_filter or gender_filter or year_filter %}
                    Tidak ada siswa yang sesuai dengan filter yang dipilih.
                    <br>Coba ubah atau reset filter pencarian Anda.
                    {% else %}
                    Belum ada data siswa dalam sistem.
                    <br>Mulai tambahkan siswa dengan klik tombol di bawah.
                    {% endif %}
                </p>
                {% if search or class_filter or status_filter or gender_filter or year_filter %}
                <a href="{% url 'students:list' %}" class="btn-modern btn-outline">
                    <i class="fas fa-redo"></i>
                    <span>Reset Filter</span>
                </a>
                {% else %}
                <a href="{% url 'students:create' %}" class="btn-modern btn-primary">
                    <i class="fas fa-user-plus"></i>
                    <span>Tambah Siswa Pertama</span>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Pagination -->
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="mt-8 pt-6 border-t border-gray-200">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <!-- Page Info -->
                <div class="text-sm text-gray-600">
                    Halaman <span class="font-semibold text-indigo-600">{{ page_obj.number }}</span> dari <span class="font-semibold text-indigo-600">{{ page_obj.paginator.num_pages }}</span>
                </div>

                <!-- Pagination Controls -->
                <div class="pagination">
                    {% if page_obj.has_previous %}
                    <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if class_filter %}&class={{ class_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gender_filter %}&gender={{ gender_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="pagination-item">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if class_filter %}&class={{ class_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gender_filter %}&gender={{ gender_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="pagination-item">
                        <i class="fas fa-angle-left"></i>
                    </a>
                    {% else %}
                    <span class="pagination-item disabled">
                        <i class="fas fa-angle-double-left"></i>
                    </span>
                    <span class="pagination-item disabled">
                        <i class="fas fa-angle-left"></i>
                    </span>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <span class="pagination-item active">{{ num }}</span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if class_filter %}&class={{ class_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gender_filter %}&gender={{ gender_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="pagination-item">{{ num }}</a>
                        {% elif num == 1 or num == page_obj.paginator.num_pages %}
                        <a href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if class_filter %}&class={{ class_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gender_filter %}&gender={{ gender_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="pagination-item">{{ num }}</a>
                        {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                        <span class="pagination-item disabled">...</span>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if class_filter %}&class={{ class_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gender_filter %}&gender={{ gender_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="pagination-item">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if class_filter %}&class={{ class_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if gender_filter %}&gender={{ gender_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="pagination-item">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                    {% else %}
                    <span class="pagination-item disabled">
                        <i class="fas fa-angle-right"></i>
                    </span>
                    <span class="pagination-item disabled">
                        <i class="fas fa-angle-double-right"></i>
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- ==================== DELETE CONFIRMATION MODAL ==================== -->
<div id="deleteModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-center text-gray-900 mb-2">Konfirmasi Hapus</h3>
            <p class="text-center text-gray-600 mb-6">
                Anda yakin ingin menghapus siswa <strong id="studentName"></strong>?
                <br>Tindakan ini tidak dapat dibatalkan.
            </p>
            <div class="flex gap-3">
                <button type="button" onclick="closeDeleteModal()" class="flex-1 btn-modern btn-outline">
                    <i class="fas fa-times"></i>
                    <span>Batal</span>
                </button>
                <button type="button" onclick="confirmDelete()" class="flex-1 btn-modern" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                    <i class="fas fa-trash-alt"></i>
                    <span>Ya, Hapus</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== BULK DELETE CONFIRMATION MODAL ==================== -->
<div id="bulkDeleteModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-center text-gray-900 mb-2">Konfirmasi Hapus Massal</h3>
            <p class="text-center text-gray-600 mb-6">
                Anda yakin ingin menghapus <strong id="bulkCount"></strong> siswa yang dipilih?
                <br>Tindakan ini tidak dapat dibatalkan.
            </p>
            <div class="flex gap-3">
                <button type="button" onclick="closeBulkDeleteModal()" class="flex-1 btn-modern btn-outline">
                    <i class="fas fa-times"></i>
                    <span>Batal</span>
                </button>
                <button type="button" onclick="confirmBulkDelete()" class="flex-1 btn-modern" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                    <i class="fas fa-trash-alt"></i>
                    <span>Ya, Hapus Semua</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ==================== CSRF TOKEN SETUP ====================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// ==================== COPY TO CLIPBOARD ====================
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('NISN berhasil disalin!', 'success');
    }).catch(err => {
        showNotification('Gagal menyalin NISN', 'error');
    });
}

// ==================== FILTER MANAGEMENT ====================
function removeFilter(filterName) {
    const url = new URL(window.location.href);
    url.searchParams.delete(filterName);
    window.location.href = url.toString();
}

// ==================== BULK ACTIONS ====================
let selectedStudents = new Set();

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.student-checkbox:checked');
    selectedStudents = new Set(Array.from(checkboxes).map(cb => cb.value));
    
    const count = selectedStudents.size;
    const bulkBar = document.getElementById('bulkActionsBar');
    const countElement = document.getElementById('selectedCount');
    
    if (count > 0) {
        bulkBar.style.display = 'block';
        countElement.textContent = count;
    } else {
        bulkBar.style.display = 'none';
    }
    
    // Update select all checkbox state
    const selectAllCheckboxes = document.querySelectorAll('#selectAll, #selectAllHeader');
    const totalCheckboxes = document.querySelectorAll('.student-checkbox').length;
    selectAllCheckboxes.forEach(cb => {
        cb.checked = count === totalCheckboxes && count > 0;
        cb.indeterminate = count > 0 && count < totalCheckboxes;
    });
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBulkActions();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.student-checkbox, #selectAll, #selectAllHeader');
    checkboxes.forEach(cb => {
        cb.checked = false;
        cb.indeterminate = false;
    });
    selectedStudents.clear();
    document.getElementById('bulkActionsBar').style.display = 'none';
}

function bulkDelete() {
    if (selectedStudents.size === 0) {
        showNotification('Tidak ada siswa yang dipilih', 'warning');
        return;
    }
    
    document.getElementById('bulkCount').textContent = selectedStudents.size;
    const modal = document.getElementById('bulkDeleteModal');
    modal.classList.add('active');
}

function confirmBulkDelete() {
    const deleteBtn = event.target.closest('button');
    const originalContent = deleteBtn.innerHTML;
    
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner"></span> Menghapus...';
    
    fetch('{% url "students:bulk_delete" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            student_ids: Array.from(selectedStudents)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`${data.deleted_count} siswa berhasil dihapus`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'Terjadi kesalahan');
        }
    })
    .catch(error => {
        showNotification(error.message, 'error');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalContent;
    });
}

function closeBulkDeleteModal() {
    const modal = document.getElementById('bulkDeleteModal');
    modal.classList.remove('active');
}

// ==================== SINGLE DELETE ====================
let deleteStudentId = null;

function deleteStudent(studentId, studentName) {
    deleteStudentId = studentId;
    document.getElementById('studentName').textContent = studentName;
    
    const modal = document.getElementById('deleteModal');
    modal.classList.add('active');
}

function confirmDelete() {
    if (!deleteStudentId) return;
    
    const deleteBtn = event.target.closest('button');
    const originalContent = deleteBtn.innerHTML;
    
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner"></span> Menghapus...';
    
    fetch(`/students/${deleteStudentId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Siswa berhasil dihapus', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'Terjadi kesalahan');
        }
    })
    .catch(error => {
        showNotification(error.message, 'error');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalContent;
    });
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('active');
    deleteStudentId = null;
}

function closeModal(event) {
    if (event.target.classList.contains('modal-overlay')) {
        closeDeleteModal();
        closeBulkDeleteModal();
    }
}

// ==================== NOTIFICATION SYSTEM ====================
function showNotification(message, type = 'info', duration = 5000) {
    // Remove existing notifications
    const existingNotifs = document.querySelectorAll('.notification-toast');
    existingNotifs.forEach(n => n.remove());
    
    const colors = {
        success: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
        error: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
        warning: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
        info: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'
    };
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    const notification = document.createElement('div');
    notification.className = 'notification-toast';
    notification.style.cssText = `
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 9999;
        background: ${colors[type]};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
    `;
    
    notification.innerHTML = `
        <i class="fas ${icons[type]} text-xl"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-times text-sm"></i>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    if (duration > 0) {
        setTimeout(() => {
            notification.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, duration);
    }
}

// ==================== KEYBOARD SHORTCUTS ====================
document.addEventListener('keydown', function(e) {
    // Escape key closes modals
    if (e.key === 'Escape') {
        closeDeleteModal();
        closeBulkDeleteModal();
    }
    
    // Ctrl/Cmd + K focuses search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.querySelector('input[name="search"]')?.focus();
    }
});

// ==================== SMOOTH SCROLL ====================
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// ==================== INITIALIZE ====================
document.addEventListener('DOMContentLoaded', function() {
    // Auto-hide notifications after page load
    {% if messages %}
    {% for message in messages %}
    showNotification('{{ message }}', '{{ message.tags }}');
    {% endfor %}
    {% endif %}
    
    // Initialize tooltips for touch devices
    if ('ontouchstart' in window) {
        document.querySelectorAll('.tooltip').forEach(el => {
            el.addEventListener('touchstart', function() {
                this.querySelector('.tooltiptext')?.classList.add('visible');
            });
            el.addEventListener('touchend', function() {
                setTimeout(() => {
                    this.querySelector('.tooltiptext')?.classList.remove('visible');
                }, 2000);
            });
        });
    }
});
</script>
{% endblock %}
