{% extends 'base.html' %}
{% load static %}

{% block title %}Daftar Siswa & RMIB - PRESTISIA{% endblock %}

{% block extra_css %}
<style>
/* ==================== ENHANCED ANIMATIONS & TRANSITIONS ==================== */
.fade-in { 
    animation: fadeIn 0.6s ease-in-out; 
    opacity: 0;
    animation-fill-mode: forwards;
}
.slide-in-up { 
    animation: slideInUp 0.5s ease-out; 
    opacity: 0;
    animation-fill-mode: forwards;
}
.slide-in-right { 
    animation: slideInRight 0.4s ease-out; 
    opacity: 0;
    animation-fill-mode: forwards;
}
.bounce-in { 
    animation: bounceIn 0.7s ease-out; 
    opacity: 0;
    animation-fill-mode: forwards;
}
.scale-in { 
    animation: scaleIn 0.4s ease-out; 
    opacity: 0;
    animation-fill-mode: forwards;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes slideInUp {
    from { opacity: 0; transform: translateY(50px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(40px); }
    to { opacity: 1; transform: translateX(0); }
}
@keyframes bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); opacity: 1; }
}
@keyframes scaleIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* ==================== BULK ACTIONS ENHANCEMENTS ==================== */
.bulk-actions-bar {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin: 1rem 0;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.25);
    transform: translateY(-20px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid #4b5563;
}

.bulk-actions-bar.show {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
}

.bulk-actions-bar .counter {
    color: #fbbf24;
    font-weight: 600;
    font-size: 1.1rem;
}

.bulk-delete-btn {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

.bulk-delete-btn:hover {
    background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(185, 28, 28, 0.4);
}

.bulk-delete-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* ==================== CHECKBOX ENHANCEMENTS ==================== */
.student-checkbox {
    transform: scale(1.2);
    accent-color: #3b82f6;
    cursor: pointer;
}

.student-checkbox:checked {
    accent-color: #1d4ed8;
}

.select-all-checkbox {
    transform: scale(1.3);
    accent-color: #059669;
    cursor: pointer;
}

.checkbox-cell {
    width: 50px;
    padding-right: 1rem;
}

.table-row.selected {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
}

/* ==================== ENHANCED CARD EFFECTS ==================== */
.hover-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateZ(0);
}
.hover-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
}

/* ==================== PROGRESS BAR ENHANCEMENTS ==================== */
.progress-bar {
    background: linear-gradient(90deg, #10B981 0%, #059669 100%);
    height: 8px;
    border-radius: 4px;
    transition: width 0.8s ease-out;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.progress-bar-blue {
    background: linear-gradient(90deg, #3B82F6 0%, #1D4ED8 100%);
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.progress-bar-yellow {
    background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

/* ==================== STATUS BADGES ==================== */
.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    transition: all 0.2s ease;
}

.status-badge:hover {
    transform: scale(1.05);
}

/* ==================== PAGINATION ENHANCEMENTS ==================== */
.pagination-container {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.pagination-info {
    font-size: 0.875rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn {
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    border: 1px solid #d1d5db;
    background: white;
    color: #374151;
}

.pagination-btn:hover:not(.disabled) {
    background: #f3f4f6;
    transform: translateY(-1px);
}

.pagination-btn.current {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ==================== SEARCH & FILTER ENHANCEMENTS ==================== */
.filter-form {
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
}

.filter-form:hover {
    box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15);
}

.form-input {
    transition: all 0.3s ease;
    border: 1px solid #d1d5db;
}

.form-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

/* ==================== TABLE ENHANCEMENTS ==================== */
.data-table {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
}

.table-row {
    transition: all 0.2s ease;
    border-bottom: 1px solid #f3f4f6;
}

.table-row:hover:not(.selected) {
    background: #f8fafc;
    transform: scale(1.001);
}

.table-row:last-child {
    border-bottom: none;
}

/* ==================== RESPONSIVE ENHANCEMENTS ==================== */
@media (max-width: 768px) {
    .hover-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .pagination-controls {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .filter-form {
        margin: 1rem;
        padding: 1rem;
    }
    
    .bulk-actions-bar {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}

/* ==================== ENHANCED TOOLTIPS ==================== */
.tooltip-trigger:hover .tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateY(-2px);
}

.tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-5px);
    background: #1f2937;
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: 10;
}

.tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: #1f2937;
}

/* ==================== TOAST NOTIFICATIONS ==================== */
.toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1000;
    max-width: 400px;
}

.toast {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    margin-bottom: 0.5rem;
    padding: 1rem;
    border-left: 4px solid;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.toast.show {
    transform: translateX(0);
}

.toast-success {
    border-left-color: #10b981;
}

.toast-error {
    border-left-color: #ef4444;
}

.toast-warning {
    border-left-color: #f59e0b;
}

.toast-info {
    border-left-color: #3b82f6;
}

/* ==================== CONFIRMATION MODAL ==================== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease;
}

.modal-overlay.show .modal-content {
    transform: translate(-50%, -50%) scale(1);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
    <!-- Enhanced Header Section -->
    <header class="bg-white shadow-lg border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between fade-in">
                <div class="mb-6 lg:mb-0">
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-users text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">
                                Daftar Siswa & RMIB
                            </h1>
                            <p class="text-gray-600">Kelola data siswa dan hasil tes RMIB</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-users text-blue-500"></i>
                            <span><strong>{{ total_students }}</strong> siswa terdaftar</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span><strong>{{ completed_tests }}</strong> tes selesai</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-clock text-yellow-500"></i>
                            <span><strong>{{ pending_tests }}</strong> belum tes</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-calendar-alt text-purple-500"></i>
                            <span>Update: {{ "now"|date:"d M Y, H:i" }}</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <a href="{% url 'students:export_csv' %}" 
                       class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-semibold rounded-xl hover:from-gray-700 hover:to-gray-800 transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl">
                        <i class="fas fa-download mr-2"></i>
                        Export CSV
                    </a>
                    <a href="{% url 'students:batch_import' %}" 
                       class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold rounded-xl hover:from-green-700 hover:to-emerald-700 transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl">
                        <i class="fas fa-upload mr-2"></i>
                        Import Batch
                    </a>
                    <a href="{% url 'students:create' %}" 
                       class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-200 shadow-lg hover:shadow-xl">
                        <i class="fas fa-plus mr-2"></i>
                        Tambah Siswa
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Enhanced Stats Cards -->
    <section class="max-w-7xl mx-auto px-4 -mt-4 relative z-10">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Siswa -->
            <div class="bg-white rounded-2xl p-6 shadow-lg hover-card bounce-in">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-blue-600 font-semibold bg-blue-50 px-2 py-1 rounded-full">
                            Total
                        </span>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" data-stat="total">{{ total_students|default:0 }}</h3>
                <p class="text-gray-600 text-sm">Siswa Terdaftar</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2">
                    <div class="progress-bar" style="width: 100%"></div>
                </div>
            </div>

            <!-- Tes Selesai -->
            <div class="bg-white rounded-2xl p-6 shadow-lg hover-card bounce-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-green-600 font-semibold bg-green-50 px-2 py-1 rounded-full">
                            {% if total_students > 0 %}
                                {% widthratio completed_tests total_students 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </span>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ completed_tests|default:0 }}</h3>
                <p class="text-gray-600 text-sm">Tes Selesai</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2">
                    <div class="progress-bar" style="width: {% if total_students > 0 %}{% widthratio completed_tests total_students 100 %}{% else %}0{% endif %}%"></div>
                </div>
            </div>

            <!-- Sedang Tes -->
            <div class="bg-white rounded-2xl p-6 shadow-lg hover-card bounce-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-play-circle text-blue-600 text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-blue-600 font-semibold bg-blue-50 px-2 py-1 rounded-full">
                            {% if total_students > 0 %}
                                {% widthratio in_progress_tests total_students 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </span>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ in_progress_tests|default:0 }}</h3>
                <p class="text-gray-600 text-sm">Sedang Tes</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2">
                    <div class="progress-bar progress-bar-blue" style="width: {% if total_students > 0 %}{% widthratio in_progress_tests total_students 100 %}{% else %}0{% endif %}%"></div>
                </div>
            </div>

            <!-- Belum Tes -->
            <div class="bg-white rounded-2xl p-6 shadow-lg hover-card bounce-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-yellow-600 font-semibold bg-yellow-50 px-2 py-1 rounded-full">
                            {% if total_students > 0 %}
                                {% widthratio pending_tests total_students 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </span>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ pending_tests|default:0 }}</h3>
                <p class="text-gray-600 text-sm">Belum Tes</p>
                <div class="mt-3 bg-gray-200 rounded-full h-2">
                    <div class="progress-bar progress-bar-yellow" style="width: {% if total_students > 0 %}{% widthratio pending_tests total_students 100 %}{% else %}0{% endif %}%"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Enhanced Filters & Search -->
    <section class="max-w-7xl mx-auto px-4 mb-6">
        <div class="filter-form p-6 slide-in-up">
            <form method="get" class="space-y-4" id="filterForm">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
                    <!-- Global Search -->
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-search mr-2 text-gray-400"></i>Pencarian Global
                        </label>
                        <input type="text" 
                               name="search" 
                               value="{{ search }}" 
                               placeholder="Cari nama, NISN, tempat lahir..." 
                               class="form-input w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>

                    <!-- Class Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-layer-group mr-2 text-gray-400"></i>Kelas
                        </label>
                        <select name="class" class="form-input w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            <option value="">Semua Kelas</option>
                            {% for class_name in available_classes %}
                                <option value="{{ class_name }}" {% if class_filter == class_name %}selected{% endif %}>
                                    Kelas {{ class_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-flag mr-2 text-gray-400"></i>Status
                        </label>
                        <select name="status" class="form-input w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            <option value="">Semua Status</option>
                            {% for status_value, status_label in status_choices %}
                                <option value="{{ status_value }}" {% if status_filter == status_value %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Gender Filter -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-venus-mars mr-2 text-gray-400"></i>Jenis Kelamin
                        </label>
                        <select name="gender" class="form-input w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            <option value="">Semua</option>
                            {% for gender_value, gender_label in gender_choices %}
                                <option value="{{ gender_value }}" {% if gender_filter == gender_value %}selected{% endif %}>
                                    {{ gender_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col justify-end space-y-2">
                        <button type="submit" 
                                class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                        <a href="{% url 'students:list' %}" 
                           class="w-full px-6 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 transition-all duration-200 text-center">
                            <i class="fas fa-refresh mr-2"></i>Reset
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <!-- Bulk Actions Bar (Hidden by default) -->
    {% if request.user.is_staff %}
    <section class="max-w-7xl mx-auto px-4">
        <div class="bulk-actions-bar" id="bulkActionsBar">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check-square text-blue-400"></i>
                        <span class="text-white">
                            <span class="counter" id="selectedCounter">0</span> siswa dipilih
                        </span>
                    </div>
                    <button type="button" 
                            id="selectAllVisible"
                            class="text-blue-400 hover:text-blue-300 text-sm underline transition-colors">
                        Pilih semua di halaman ini
                    </button>
                    <button type="button" 
                            id="clearSelection"
                            class="text-gray-400 hover:text-gray-300 text-sm underline transition-colors">
                        Batalkan pilihan
                    </button>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" 
                            id="bulkDeleteBtn"
                            class="bulk-delete-btn">
                        <i class="fas fa-trash-alt mr-2"></i>
                        Hapus Terpilih
                    </button>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Enhanced Students Table -->
    <section class="max-w-7xl mx-auto px-4 mb-8">
        <div class="data-table fade-in">
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            {% if request.user.is_staff %}
                            <th class="checkbox-cell px-4 py-4 text-left">
                                <div class="flex items-center justify-center">
                                    <input type="checkbox" 
                                           id="selectAll"
                                           class="select-all-checkbox"
                                           title="Pilih/batalkan semua">
                                </div>
                            </th>
                            {% endif %}
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-user"></i>
                                    <span>Siswa</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>Kelas</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-flag"></i>
                                    <span>Status RMIB</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-star"></i>
                                    <span>Minat Teratas</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Progress</span>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-cogs"></i>
                                    <span>Aksi</span>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for student in students %}
                        <tr class="table-row" data-student-id="{{ student.pk }}" data-student-name="{{ student.name }}">
                            {% if request.user.is_staff %}
                            <td class="checkbox-cell px-4 py-4">
                                <div class="flex items-center justify-center">
                                    <input type="checkbox" 
                                           class="student-checkbox"
                                           data-student-id="{{ student.pk }}"
                                           data-student-name="{{ student.name }}"
                                           value="{{ student.pk }}">
                                </div>
                            </td>
                            {% endif %}
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-4">
                                    <div class="relative tooltip-trigger">
                                        <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                            {{ student.name|first|upper }}
                                        </div>
                                        <div class="tooltip">
                                            {{ student.name }}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-sm font-semibold text-gray-900">{{ student.name }}</div>
                                        <div class="text-xs text-gray-500 space-y-1">
                                            <div><strong>NISN:</strong> {{ student.nisn }}</div>
                                            <div><strong>{{ student.get_gender_display }}:</strong> {{ student.birth_date|date:"d M Y" }}</div>
                                            {% if student.birth_place %}
                                                <div><strong>TTL:</strong> {{ student.birth_place }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="space-y-2">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-graduation-cap mr-1"></i>
                                        {{ student.student_class }}
                                    </span>
                                    <div class="text-xs text-gray-500">
                                        Angkatan {{ student.entry_year }}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                {% if student.test_status == 'pending' %}
                                    <span class="status-badge bg-yellow-100 text-yellow-700">
                                        <i class="fas fa-hourglass-half mr-1"></i>Belum Tes
                                    </span>
                                {% elif student.test_status == 'in_progress' %}
                                    <span class="status-badge bg-blue-100 text-blue-700">
                                        <i class="fas fa-play-circle mr-1"></i>Sedang Tes
                                    </span>
                                {% elif student.test_status == 'completed' %}
                                    <span class="status-badge bg-green-100 text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i>Selesai
                                    </span>
                                {% endif %}
                                
                                {% if student.test_date %}
                                    <div class="text-xs text-gray-400 mt-1">
                                        {{ student.test_date|date:"d M Y" }}
                                    </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-1">
                                    {% if student.test_status == 'completed' %}
                                        <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">Scientific</span>
                                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">Medical</span>
                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">Social</span>
                                    {% else %}
                                        <span class="text-xs text-gray-400 italic">Belum tersedia</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-3">
                                    {% if student.test_status == 'completed' %}
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full transition-all duration-1000" style="width: 100%"></div>
                                        </div>
                                        <span class="text-xs font-medium text-gray-600 min-w-0">100%</span>
                                    {% elif student.test_status == 'in_progress' %}
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" style="width: 65%"></div>
                                        </div>
                                        <span class="text-xs font-medium text-gray-600 min-w-0">65%</span>
                                    {% else %}
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gray-300 h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs font-medium text-gray-600 min-w-0">0%</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center space-x-2">
                                    <a href="{% url 'students:detail' student.pk %}" 
                                       class="inline-flex items-center px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-xs font-medium tooltip-trigger relative">
                                        <i class="fas fa-eye mr-1"></i>Detail
                                        <div class="tooltip">Lihat detail siswa</div>
                                    </a>
                                    
                                    {% if request.user.is_staff %}
                                        <a href="{% url 'students:update' student.pk %}" 
                                           class="inline-flex items-center px-3 py-1.5 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-xs font-medium tooltip-trigger relative">
                                            <i class="fas fa-edit mr-1"></i>Edit
                                            <div class="tooltip">Edit data siswa</div>
                                        </a>
                                        
                                        <button onclick="deleteStudent({{ student.pk }}, '{{ student.name|escapejs }}')" 
                                                class="inline-flex items-center px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-xs font-medium tooltip-trigger relative">
                                            <i class="fas fa-trash-alt mr-1"></i>Hapus
                                            <div class="tooltip">Hapus siswa</div>
                                        </button>
                                    {% endif %}
                                    
                                    {% if student.test_status == 'completed' %}
                                        <button class="inline-flex items-center px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-xs font-medium tooltip-trigger relative">
                                            <i class="fas fa-chart-bar mr-1"></i>RMIB
                                            <div class="tooltip">Lihat hasil RMIB</div>
                                        </button>
                                    {% else %}
                                        <button class="inline-flex items-center px-3 py-1.5 bg-gray-100 text-gray-500 rounded-lg transition-colors text-xs font-medium tooltip-trigger relative" disabled>
                                            <i class="fas fa-chart-bar mr-1"></i>RMIB
                                            <div class="tooltip">Tes belum selesai</div>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if request.user.is_staff %}7{% else %}6{% endif %}" class="px-6 py-16 text-center">
                                <div class="flex flex-col items-center">
                                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
                                        <i class="fas fa-users text-gray-300 text-4xl"></i>
                                    </div>
                                    <h3 class="text-xl font-semibold text-gray-600 mb-2">
                                        {% if search or class_filter or status_filter or gender_filter %}
                                            Tidak ada hasil yang ditemukan
                                        {% else %}
                                            Belum ada data siswa
                                        {% endif %}
                                    </h3>
                                    <p class="text-gray-500 mb-6 max-w-md">
                                        {% if search or class_filter or status_filter or gender_filter %}
                                            Coba ubah kriteria pencarian atau filter untuk mendapatkan hasil yang berbeda
                                        {% else %}
                                            Mulai dengan menambahkan siswa baru atau import data dari file CSV
                                        {% endif %}
                                    </p>
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        {% if search or class_filter or status_filter or gender_filter %}
                                            <a href="{% url 'students:list' %}" 
                                               class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all">
                                                <i class="fas fa-refresh mr-2"></i>Reset Filter
                                            </a>
                                        {% endif %}
                                        <a href="{% url 'students:create' %}" 
                                           class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">
                                            <i class="fas fa-plus mr-2"></i>Tambah Siswa
                                        </a>
                                        <a href="{% url 'students:batch_import' %}" 
                                           class="inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all">
                                            <i class="fas fa-upload mr-2"></i>Import CSV
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Enhanced Pagination Footer -->
            {% if students %}
            <div class="pagination-container border-t border-gray-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <!-- Pagination Info -->
                    <div class="pagination-info">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        <span>
                            Showing 
                            <strong>{{ page_obj.start_index }}</strong>
                            to 
                            <strong>{{ page_obj.end_index }}</strong>
                            of 
                            <strong>{{ page_obj.paginator.count }}</strong>
                            {% if search or class_filter or status_filter or gender_filter %}
                                filtered
                            {% endif %}
                            results
                        </span>
                        {% if search or class_filter or status_filter or gender_filter %}
                            <span class="ml-2 text-blue-600">
                                | <a href="{% url 'students:list' %}" class="hover:underline">Clear filters</a>
                            </span>
                        {% endif %}
                    </div>
                    
                    <!-- Pagination Controls -->
                    {% if page_obj.paginator.num_pages > 1 %}
                    <div class="pagination-controls">
                        {% if page_obj.has_previous %}
                            <a href="?{% if search %}search={{ search }}&{% endif %}{% if class_filter %}class={{ class_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if gender_filter %}gender={{ gender_filter }}&{% endif %}page=1" 
                               class="pagination-btn">
                                <i class="fas fa-angle-double-left mr-1"></i>First
                            </a>
                            <a href="?{% if search %}search={{ search }}&{% endif %}{% if class_filter %}class={{ class_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if gender_filter %}gender={{ gender_filter }}&{% endif %}page={{ page_obj.previous_page_number }}" 
                               class="pagination-btn">
                                <i class="fas fa-angle-left mr-1"></i>Previous
                            </a>
                        {% else %}
                            <span class="pagination-btn disabled">
                                <i class="fas fa-angle-double-left mr-1"></i>First
                            </span>
                            <span class="pagination-btn disabled">
                                <i class="fas fa-angle-left mr-1"></i>Previous
                            </span>
                        {% endif %}                        
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if num == page_obj.number %}
                                <span class="pagination-btn current">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?{% if search %}search={{ search }}&{% endif %}{% if class_filter %}class={{ class_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if gender_filter %}gender={{ gender_filter }}&{% endif %}page={{ num }}" 
                                   class="pagination-btn">{{ num }}</a>
                            {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                <a href="?{% if search %}search={{ search }}&{% endif %}{% if class_filter %}class={{ class_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if gender_filter %}gender={{ gender_filter }}&{% endif %}page={{ num }}" 
                                   class="pagination-btn">{{ num }}</a>
                            {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                                <span class="pagination-btn disabled">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <a href="?{% if search %}search={{ search }}&{% endif %}{% if class_filter %}class={{ class_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if gender_filter %}gender={{ gender_filter }}&{% endif %}page={{ page_obj.next_page_number }}" 
                               class="pagination-btn">
                                Next<i class="fas fa-angle-right ml-1"></i>
                            </a>
                            <a href="?{% if search %}search={{ search }}&{% endif %}{% if class_filter %}class={{ class_filter }}&{% endif %}{% if status_filter %}status={{ status_filter }}&{% endif %}{% if gender_filter %}gender={{ gender_filter }}&{% endif %}page={{ page_obj.paginator.num_pages }}" 
                               class="pagination-btn">
                                Last<i class="fas fa-angle-double-right ml-1"></i>
                            </a>
                        {% else %}
                            <span class="pagination-btn disabled">
                                Next<i class="fas fa-angle-right ml-1"></i>
                            </span>
                            <span class="pagination-btn disabled">
                                Last<i class="fas fa-angle-double-right ml-1"></i>
                            </span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Bulk Delete Confirmation Modal -->
    <div class="modal-overlay" id="bulkDeleteModal">
        <div class="modal-content">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Konfirmasi Hapus Multiple</h3>
                    <p class="text-gray-600">Tindakan ini tidak dapat dibatalkan!</p>
                </div>
            </div>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <p class="text-red-800 font-medium mb-2">
                    Anda akan menghapus <span id="deleteCount" class="font-bold">0</span> siswa berikut:
                </p>
                <div id="studentList" class="max-h-40 overflow-y-auto text-sm text-red-700">
                    <!-- Student names will be inserted here -->
                </div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-yellow-800 mb-2">Konsekuensi:</h4>
                <ul class="text-yellow-700 text-sm space-y-1">
                    <li>• Semua data siswa akan dihapus permanen</li>
                    <li>• Akun login akan ikut terhapus</li>
                    <li>• Riwayat prestasi akan hilang</li>
                    <li>• Hasil tes RMIB akan terhapus</li>
                </ul>
            </div>
            
            <div class="flex items-center mb-4">
                <input type="checkbox" id="confirmBulkDelete" class="mr-3 scale-125">
                <label for="confirmBulkDelete" class="text-gray-900">
                    Saya memahami konsekuensi dan yakin untuk menghapus siswa-siswa ini
                </label>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" 
                        id="cancelBulkDelete"
                        class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all">
                    Batal
                </button>
                <button type="button" 
                        id="confirmBulkDeleteBtn"
                        disabled
                        class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed transition-all">
                    Hapus Semua
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
</div>

<!-- Hidden form for bulk delete -->
{% if request.user.is_staff %}
<form id="bulkDeleteForm" method="post" action="{% url 'students:bulk_delete' %}" style="display: none;">
    {% csrf_token %}
    <div id="selectedStudentIds"></div>
</form>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    // Check if CSRF token exists
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('meta[name=csrf-token]')?.content;
    
    if (!csrfToken) {
        console.error('CSRF token not found!');
    }
    
    // Global variables
    let selectedStudents = new Set();
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCounter = document.getElementById('selectedCounter');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkDeleteModal = document.getElementById('bulkDeleteModal');
    
    // Initialize bulk actions functionality
    if (bulkActionsBar) {
        initializeBulkActions();
    }
    
    function initializeBulkActions() {
        // Individual checkbox change handler
        studentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleStudentCheckboxChange);
        });
        
        // Select all checkbox handler
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', handleSelectAllChange);
        }
        
        // Bulk action buttons
        document.getElementById('selectAllVisible')?.addEventListener('click', selectAllVisible);
        document.getElementById('clearSelection')?.addEventListener('click', clearAllSelections);
        bulkDeleteBtn?.addEventListener('click', showBulkDeleteModal);
        
        // Modal handlers
        document.getElementById('cancelBulkDelete')?.addEventListener('click', hideBulkDeleteModal);
        document.getElementById('confirmBulkDelete')?.addEventListener('change', toggleConfirmButton);
        document.getElementById('confirmBulkDeleteBtn')?.addEventListener('click', executeBulkDelete);
        
        // Close modal on overlay click
        bulkDeleteModal?.addEventListener('click', function(e) {
            if (e.target === this) {
                hideBulkDeleteModal();
            }
        });
    }
    
    function handleStudentCheckboxChange(e) {
        const checkbox = e.target;
        const studentId = checkbox.dataset.studentId;
        const studentName = checkbox.dataset.studentName;
        const row = checkbox.closest('tr');
        
        if (checkbox.checked) {
            selectedStudents.add({ id: studentId, name: studentName });
            row.classList.add('selected');
        } else {
            selectedStudents.delete(Array.from(selectedStudents).find(s => s.id === studentId));
            row.classList.remove('selected');
        }
        
        updateBulkActionsBar();
        updateSelectAllCheckbox();
    }
    
    function handleSelectAllChange(e) {
        const isChecked = e.target.checked;
        
        studentCheckboxes.forEach(checkbox => {
            const studentId = checkbox.dataset.studentId;
            const studentName = checkbox.dataset.studentName;
            const row = checkbox.closest('tr');
            
            checkbox.checked = isChecked;
            
            if (isChecked) {
                selectedStudents.add({ id: studentId, name: studentName });
                row.classList.add('selected');
            } else {
                selectedStudents.delete(Array.from(selectedStudents).find(s => s.id === studentId));
                row.classList.remove('selected');
            }
        });
        
        updateBulkActionsBar();
    }
    
    function selectAllVisible() {
        studentCheckboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
    }
    
    function clearAllSelections() {
        studentCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
        
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
        }
    }
    
    function updateBulkActionsBar() {
        const count = selectedStudents.size;
        selectedCounter.textContent = count;
        
        if (count > 0) {
            bulkActionsBar.classList.add('show');
        } else {
            bulkActionsBar.classList.remove('show');
        }
    }
    
    function updateSelectAllCheckbox() {
        if (!selectAllCheckbox) return;
        
        const totalCheckboxes = studentCheckboxes.length;
        const checkedCheckboxes = document.querySelectorAll('.student-checkbox:checked').length;
        
        selectAllCheckbox.checked = totalCheckboxes > 0 && checkedCheckboxes === totalCheckboxes;
        selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
    }
    
    function showBulkDeleteModal() {
        if (selectedStudents.size === 0) return;
        
        // Update modal content
        document.getElementById('deleteCount').textContent = selectedStudents.size;
        
        const studentList = document.getElementById('studentList');
        studentList.innerHTML = '';
        
        Array.from(selectedStudents).forEach((student, index) => {
            const item = document.createElement('div');
            item.className = 'flex items-center space-x-2 py-1';
            item.innerHTML = `
                <span class="w-6 text-center font-medium">${index + 1}.</span>
                <span>${student.name}</span>
            `;
            studentList.appendChild(item);
        });
        
        // Reset confirmation
        document.getElementById('confirmBulkDelete').checked = false;
        document.getElementById('confirmBulkDeleteBtn').disabled = true;
        
        // Show modal
        bulkDeleteModal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    function hideBulkDeleteModal() {
        bulkDeleteModal.classList.remove('show');
        document.body.style.overflow = '';
    }
    
    function toggleConfirmButton() {
        const checkbox = document.getElementById('confirmBulkDelete');
        const button = document.getElementById('confirmBulkDeleteBtn');
        button.disabled = !checkbox.checked;
    }
    
    function executeBulkDelete() {
        if (selectedStudents.size === 0) return;
        
        console.log('Executing bulk delete for:', Array.from(selectedStudents));
        
        // Create form data
        const form = document.getElementById('bulkDeleteForm');
        if (!form) {
            console.error('Bulk delete form not found!');
            showNotification('Form tidak ditemukan', 'error');
            return;
        }
        
        const studentIds = document.getElementById('selectedStudentIds');
        studentIds.innerHTML = '';
        
        Array.from(selectedStudents).forEach(student => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'student_ids';
            input.value = student.id;
            studentIds.appendChild(input);
            console.log('Added student ID to form:', student.id);
        });
        
        // Show loading state
        const button = document.getElementById('confirmBulkDeleteBtn');
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menghapus...';
        button.disabled = true;
        
        showNotification(`Menghapus ${selectedStudents.size} siswa...`, 'info', 0);
        
        // Submit form
        console.log('Submitting bulk delete form...');
        form.submit();
    }
    
    // Individual delete function with better error handling
    window.deleteStudent = function(studentId, studentName) {
        console.log(`Delete student called: ID=${studentId}, Name=${studentName}`);
        
        if (!confirm(`Apakah Anda yakin ingin menghapus siswa "${studentName}"?\n\nTindakan ini tidak dapat dibatalkan!`)) {
            return;
        }
        
        const confirmation = prompt(`Untuk mengonfirmasi penghapusan siswa "${studentName}", ketik "HAPUS":`);
        
        if (confirmation !== 'HAPUS') {
            showNotification('Penghapusan dibatalkan. Konfirmasi tidak sesuai.', 'info');
            return;
        }
        
        if (!csrfToken) {
            showNotification('CSRF token tidak ditemukan. Refresh halaman dan coba lagi.', 'error');
            return;
        }
        
        showNotification('Menghapus siswa...', 'info', 0);
        
        // AJAX delete request
        const deleteUrl = `/students/${studentId}/delete-ajax/`;
        console.log('Sending delete request to:', deleteUrl);
        
        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            credentials: 'same-origin', // Include cookies
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Delete response data:', data);
            document.querySelector('.toast')?.remove();
            
            if (data.success) {
                showNotification(data.message, 'success', 3000);
                
                // Remove the row from table with animation
                const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        row.remove();
                        updateStudentCounts();
                    }, 300);
                }
                
                // Redirect or reload after delay
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        window.location.reload();
                    }
                }, 1500);
                
            } else {
                showNotification(data.message || 'Gagal menghapus siswa', 'error', 5000);
            }
        })
        .catch(error => {
            document.querySelector('.toast')?.remove();
            console.error('Delete error:', error);
            showNotification('Terjadi kesalahan saat menghapus siswa: ' + error.message, 'error', 5000);
        });
    };
    
    // Update student counts function
    function updateStudentCounts() {
        const rows = document.querySelectorAll('tbody tr[data-student-id]');
        const totalCount = rows.length;
        
        const totalElement = document.querySelector('[data-stat="total"]');
        if (totalElement) {
            totalElement.textContent = totalCount;
        }
    }
    
    // Enhanced toast notification function
    function showNotification(message, type = 'info', duration = 5000) {
        // Remove existing toasts
        document.querySelectorAll('.toast').forEach(t => t.remove());
        
        const toast = document.createElement('div');
        const colors = {
            success: 'toast-success',
            error: 'toast-error',
            warning: 'toast-warning',
            info: 'toast-info'
        };
        
        const icons = {
            success: 'fas fa-check-circle text-green-600',
            error: 'fas fa-exclamation-circle text-red-600',
            warning: 'fas fa-exclamation-triangle text-yellow-600',
            info: 'fas fa-info-circle text-blue-600'
        };
        
        toast.className = `toast ${colors[type]}`;
        toast.innerHTML = `
            <div class="flex items-start space-x-3">
                <i class="${icons[type]} mt-0.5" aria-hidden="true"></i>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 leading-relaxed">${message}</p>
                </div>
                <button onclick="this.closest('.toast').remove()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        const container = document.getElementById('toastContainer');
        if (container) {
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) toast.remove();
                    }, 300);
                }, duration);
            }
        }
    }
    
    // Initialize other features
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach((bar, index) => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500 + (index * 200));
    });
    
    console.log('Delete system initialized successfully');
    console.log('CSRF Token:', csrfToken ? 'Found' : 'Missing');
    console.log('Staff permissions:', {{ request.user.is_staff|yesno:"true,false" }});
});
</script>
{% endblock %}
